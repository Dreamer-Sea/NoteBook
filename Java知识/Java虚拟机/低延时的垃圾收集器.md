# 低延迟的垃圾收集器
[toc]
## 垃圾收集器的不可能三角
衡量垃圾收集器的三项最重要的指标是：**内存占用(Footprint)**、**吞吐量(Throughput)**、**延迟(Latency)**。

## Shenandoah收集器
### 现状
这个收集器在任何堆内存大小都可以把垃圾收集的停顿时间限制在十毫秒内。该收集器更像是G1收集器的改进版本。
由RedHat公司提出并实现，并捐赠给了OpenJDK，在OpenJDK 12中提供给了开发人员。但是Oracle公司并不接收这个垃圾收集器，在OracleJDK 12中不提供支持。

### 特点
- 引用关系的记录：在G1收集器中使用卡表这一数据结构来记录跨Region的引用关系，这种数据结构会占用很大的内存空间。而Shenandoah收集器使用**连接矩阵**来记录这种引用关系，例如Region N中有对象指向Region M，则在表格的**N行M列**中打上一个标记。

### 工作阶段
九个工作阶段可以概括为三个(**并发标记**、**并发清理**，**并发引用更新**)。
- 初始标记：Stop the World，标记与GC Roots直接关联的对象，执行时间与GC Roots的对象数量有关。
- 并发标记：与**用户线程**并发执行，遍历对象图，标记出全部可达的对象，执行时间与存活对象的数量以及对象图的机构复杂度有关。
- 最终标记：与G1一样，处理剩余的SATB扫描，并在这个阶段统计出回收价值最高的Region，将这些Region构成一组回收集(Collection Set)。该阶段也会有一小段短暂的停顿。
- 并发清理：清理不含任何存活对象的Region(Immediate Garbage Region)。
- 并发回收：需要先将回收集里面的存活对象先复制一份到其他未被使用的Region中。移动后内存中指向对象的引用还是旧对象的地址，需要在引用更新阶段使用Brooks Pointer(转发指针)更新对象的地址。**该阶段的运行时间取决于回收集的大小。**
- 初始引用更新：该阶段是确保在并发回收阶段运行的线程都同步到了一个相同的起点。
- 并发引用更新：引用真正被更新的阶段，**运行时间取决于内存中涉及的引用数量的多少**。这里按照内存物理地址的顺序，线性地搜索出引用类型，把旧值改为新值。
- 最终引用更新：修正存在于GC Roots中的引用。
- 并发清理：清理回收集中的所有Region。

### Brooks Pointer
在每个对象的布局结构的最前面统一加一个新的引用字段，在正常不处于并发移动的情况下，该引用指向对象自己。在发生了移动后，旧对象的Brooks Pointer指向新对象。

## ZGC收集器
由Oracle公司研发的低延迟收集器，并提交给了OpenJDK。该收集器与Shenandoah有一致的目标就是：**对吞吐量影响不大的情况下，实现在任意堆内存大小下都可以把垃圾收集的停顿时间限制在十毫秒以内**。
**主要特征：**ZGC收集器是一款基于Region内存布局的，(暂时)不设不分代的，使用了读屏障、染色指针和内存多重映射等技术来实现可并发的标记-整理算法的，以低延迟为首要目标的一款垃圾收集器。
### Region (ZPage/Page)
在官方资料中，将ZGC的Region称为ZPage或Page。
ZGC的Region具有**动态性**——动态创建和销毁，以及动态的区域容量大小。在x64硬件平台下，Region按容量被分为了三类：
- 小型Region：容量固定大小为2MB，用于放置小于256KB的对象。
- 中型Region：容量固定大小为32MB，用于放置大于等于256KB但小于4MB的对象。
- 大型Region：容量不固定，可以动态变化，但必须为2MB的整数倍，用于放置4MB或以上的大对象。该Region在ZGC的实现中时不会被重分配的，因为复制一个大对象的代价非常高昂。

### 并发整理算法的实现
#### 染色指针(Colored Pointer, Tag Pointer, Version Pointer)
对象的存活与否跟是否有引用指向它有关，而跟其它属性无关，所以可以将标记引用的信息直接存放在指针上，而不是在对象上。这样在进行可达性分析的时候，遍历的是“引用图”。
**优势**
- Region中的存活对象被移走之后，该Region就能立即被释放或重用掉。而在所有对象都存活的极端情况下，Shenandoah收集器必须要有一半的Region空闲(**一半Region有存活对象，一半Region空闲**)。
- 减少内存屏障的使用数量。内存屏障(尤其是写屏障)是为了**记录对象引用的变动情况**。
- 该指针可以作为一种可扩展的存储结构来记录更多与对象标记、重定位过程相关的数据，以便日后进一步提高性能。

### 工作阶段
- 并发标记：标记染色指针，即更新染色指针中的Marked 0， Marked 1标志位。
- 并发预备重分配：统计需要清理的Region，并将这些Region组成重分配即。
- 并发重分配：将重分配集中的存活对象复制到新的Region中，并为重分配集中的每个Region维护一个转发表。
- 并发重映射：修正整个堆中指向重分配集中旧对象的所有引用。


