# 低延迟的垃圾收集器
[toc]
## 垃圾收集器的不可能三角
衡量垃圾收集器的三项最重要的指标是：**内存占用(Footprint)**、**吞吐量(Throughput)**、**延迟(Latency)**。

## Shenandoah收集器
### 现状
这个收集器在任何堆内存大小都可以把垃圾收集的停顿时间限制在十毫秒内。该收集器更像是G1收集器的改进版本。
由RedHat公司提出并实现，并捐赠给了OpenJDK，在OpenJDK 12中提供给了开发人员。但是Oracle公司并不接收这个垃圾收集器，在OracleJDK 12中不提供支持。

### 特点
- 引用关系的记录：在G1收集器中使用卡表这一数据结构来记录跨Region的引用关系，这种数据结构会占用很大的内存空间。而Shenandoah收集器使用**连接矩阵**来记录这种引用关系，例如Region N中有对象指向Region M，则在表格的**N行M列**中打上一个标记。

### 工作阶段
九个工作阶段可以概括为三个(**并发标记**、**并发清理**，**并发引用更新**)。
- 初始标记：Stop the World，标记与GC Roots直接关联的对象，执行时间与GC Roots的对象数量有关。
- 并发标记：与**用户线程**并发执行，遍历对象图，标记出全部可达的对象，执行时间与存活对象的数量以及对象图的机构复杂度有关。
- 最终标记：与G1一样，处理剩余的SATB扫描，并在这个阶段统计出回收价值最高的Region，将这些Region构成一组回收集(Collection Set)。该阶段也会有一小段短暂的停顿。
- 并发清理：清理不含任何存活对象的Region(Immediate Garbage Region)。
- 并发回收：需要先将回收集里面的存活对象先复制一份到其他未被使用的Region中。移动后内存中指向对象的引用还是旧对象的地址，需要在引用更新阶段使用Brooks Pointer(转发指针)更新对象的地址。**该阶段的运行时间取决于回收集的大小。**
- 初始引用更新：该阶段是确保在并发回收阶段运行的线程都同步到了一个相同的起点。
- 并发引用更新：引用真正被更新的阶段，**运行时间取决于内存中涉及的引用数量的多少**。这里按照内存物理地址的顺序，线性地搜索出引用类型，把旧值改为新值。
- 最终引用更新：修正存在于GC Roots中的引用。
- 并发清理：清理回收集中的所有Region。

### Brooks Pointer
在每个对象的布局结构的最前面统一加一个新的引用字段，在正常不处于并发移动的情况下，该引用指向对象自己。在发生了移动后，旧对象的Brooks Pointer指向新对象。

## ZGC收集器
由Oracle公司研发的低延迟收集器，并贡献给了OpenJDK。


