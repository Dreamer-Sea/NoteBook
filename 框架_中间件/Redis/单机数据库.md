# 单机数据库

# 数据库
Redis的服务器端默认有**16**个数据库。通过**SELECT**命令来切换数据库。

在每个数据库中都是使用字典来存储数据键值对。

数据库中还会维护一个expire字典(过期字典)，该字典负责记录键的过期时间，会与存储键值对的字典共享键值对对象。

# 过期删除策略
Redis中有三种方式来删除过期的键：
1. 惰性删除：每次获取键的时候，如果键已过期则删除。
2. 定期删除：每过一段时间就检查数据库中的某些键(随机选择)，如果过期则删除。

# 过期键对持久化的影响
## 对RDB的影响
1. 当服务器以**主服务器**运行时，程序会在载入RDB文件前对文件中保存的键进行检查，只有未过期的键会载入到数据库中。
2. 当服务器以**从服务器**运行时，程序会直接载入RDB文件，不论文件中保存的键是否过期都会载入到数据库中。因为在载入RDB文件的时候，从服务器的数据库就会被清空。

## 对AOF的影响
如果过期的键被删除，就会在AOF文件中追加删除命令。在AOF文件进行重写的时候，删除命令会和创建命令抵消。

## 复制模式
在复制模式下，会经过以下的步骤：
1. 主服务器删除一个过期键之后，会给从服务器发送DEL命令，告诉从服务器将该键删除。
2. 而从服务器在没接到DEL命令前，接收到客户端的读命令时，还是会将过期键返回。
3. 当从服务器在接收到了DEL命令后，才会将过期键删除。

# 持久化方式
## RDB
RDB这种备份方式是在主线程创建一个子进程，这个子进程对内存数据进行遍历且序列化到磁盘中。如果在RDB过程中，客户端执行了修改内存数据的命令，那么主进程会将需要修改的数据复制一份出来，对副本数据进行修改。

有两个命令能够触发RDB持久化，分别是**SAVE**和**BGSAVE**。前者是阻塞当前进程来进行持久化；后者是fork一个子进程，在子进程中进行持久化。

而Redis在服务器启动的时候会自动检测RDB文件，如果RDB存在则自动载入。服务器在加载RDB文件的时候，会一直处于阻塞状态直到RDB文件加载完成。

## AOF
这种备份方式不是序列化内存数据，而是存储Redis服务器的**顺序指令序列**。AOF文件中记录的是从Redis实例创建以来所有**修改性**指令序列。

**AOF重写**
因为AOF可能存在大量重复的命令。开辟一个子进程对内存进行遍历转换成一系列Redis的操作指令，并将这些操作指令序列化到一个新的AOF日志文件中，这样能够合并重复的操作指令。序列化完后，再将序列化期间的增量AOF日志追加到这个新的AOF文件中。

**fsync**
在使用AOF方式时，指令是先写入到缓冲区中。但是Redis在运行中可能因为意外而退出，这可能导致AOF操作失败。所以在Linux在提供了fsync函数，能够将指定文件的内容强制从内核缓存刷到磁盘。可以每当缓冲区中有一条新的指令就将其写入磁盘，或者1秒写入一次，甚至由操作系统自己选择什么时候持久化，一般选择1秒执行一次fsync函数。

## 混合持久化
如果服务器启动了AOF持久化，那么服务器就会先加载AOF文件来还原数据库状态。如果AOF没有启动，就会先加载RDB文件。

# 事件(event)
Redis是一个事件驱动程序。
Redis支持的事件有：
1. 文件事件
2. 时间事件

## 文件事件
![文件事件处理模型](框架_中间件\Redis\pictures\文件事件处理模型.png)
Redis使用I/O多路复用程序来控制套接字与文件事件处理器的连接。

## 时间事件
常见的时间时间有两类：
1. 定时事件
2. 周期事件
在Redis中使用的是**周期事件**。

## 事件的调度
在最近的时间事件到来前，服务器都是在执行文件事件。如果执行的文件事件太长，就会中断本次事件，将未执行完的内容放到下一次执行。
