# 独立功能的实现

[toc]

# 发布与订阅
服务器状态在**pubsub_channels字典**里保存了所有频道的订阅关系：**SUBSCRIBE命令**负责将客户端和被订阅的频道关联到这个字典里，而**UNSUBSCRIBE命令**负责解除客户端和被退订频道之间的关联。

服务器状态在**pubsub_patterns链表**保存了所有模式的订阅关系：**PSUBSCRIBE命令**负责将客户端和被订阅的模式记录到这个链表中，而**PUNSUBSCRIBE命令**则负责移除客户端和被退订模式在链表中的记录。

**PUBLISH命令**通过访问**pubsub_channels字典**来向频道的所有订阅者发送消息，通过访问**pubsub_patterns链表**来向所有匹配频道的模式的订阅者发送消息。

**PUBSUB命令**的三个子命令都是通过读取**pubsub_channels字典**和**pubsub_patterns链表**中的信息来实现的。

# 事务
**WATCH命令**会将客户端和被监视的键在数据库的**watched_keys字典**中进行关联，当键被修改时，程序会将所有被监视被修改键的客户端的**REDIS_DIRTY_CAS**标志打开。

只有在客户端的**REDIS_DIRTY_CAS标志**未被打开时，服务器才会执行客户端提交的事务，否则的话，服务器将拒绝执行客户端提交的事务。

Redis的事务总是具有ACID中的原子性、一致性和隔离性。当服务器运行在AOF持久化模式下，并且appendfsync选项的值为always时，事务也具有耐久性。

