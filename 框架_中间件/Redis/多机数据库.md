# 多级数据库

# 主从复制
Redis主从复制从2.8版本起就与之前不同了。

## 2.8之前
在2.8之前，Redis每次主从服务都要经历以下步骤：
1. 主从服务器启动，建立主从关系。
2. 从服务器向主服务器发送同步请求。
3. 主服务器执行BGSAVE命令生成RDB文件。
4. 主服务器将RDB文件发送给从服务器，同时继续接收客户端发送来的命令。
5. 从服务器清空数据库，然后加载主服务器发送过来的文件。
6. 主服务器在从服务器加载完成后，在从服务器发送加载期间，客户端发送过来的命令。
7. 从服务器执行完所有命令后，主从服务器达到一致状态。

在这种方式下，主从服务器一旦断开连接后再重新建立连接都要经历以上所有的步骤。那么在步骤3会占用主服务器的CPU，I/O资源，在步骤4占用主服务器的网络资源。

## 2.8之后
在原来的基础上加入了**部分重同步**的功能。能够只同步部分数据。

主服务器和从服务器都会维护一个**复制偏移量**，通过对比这个偏移量能够知道从服务器和主服务器的内容差距有多少。

根据**复制偏移量**和**复制积压缓冲区**能够确定从服务器使用哪种方式与主服务器同步。如果偏移量过大，超过了复制积压缓冲区的大小，就会执行完整同步，否则执行部分同步。

此外还加入了服务器id的属性，这个id是在服务器启动的时候就生成了。当主从关系建立时，主服务器会将自己的id发给从服务器。当主从关系重新建立的时候，从服务器会检查主服务器发来的id是否与之前一致，一致的话执行部分重同步，不一致的话执行完整同步。

# Sentinel(哨兵模式)
哨兵模式时Redis服务器的运行模式之一，它是用来监视其它Redis服务器的服务器。哨兵服务器监视所有的Redis服务器(主服务器，从服务器和哨兵服务器)。

## 服务器下线
如果有一台服务器与一台哨兵服务器连接超时了，那么它将被该哨兵服务器确定为主观下线。如果这台服务器与所有的哨兵服务器连接超时了，那么它就被确定为客观下线。

# 集群
节点通过**握手**来将其他节点添加到自己所处的集群当中。

每个集群都有16384个槽，这些槽能够被分别指派给集群中的各个节点。每个节点都会记录自己被分配到了哪些槽，以及集群中的其他节点被分配到了哪些槽。

每个节点在执行命令前都会判断客户端传过来的命令要处理的键所在的槽是否由自己管理，如果不是，那么该节点就要给客户端返回一个**MOVED错误**，并且说明命令要操作的槽是由哪个节点负责。

Redis集群的**重新分片**工作是由**redis-trib**负责执行的，重新分片的关键是将属于某个槽的**所有键值从**一个节点转移到另一个节点。

如果节点A正在迁移槽*i*至节点B，那么当节点A没能在自己的数据库中找到命令指定的数据库键时，节点A会向客户端返回一个ASK错误，指引客户端到节点B继续查找指定的数据库键。

**MOVED错误**表示槽的负责权已经从一个节点转移到另一个节点，而**ASK错误**只是两个节点在迁移槽的过程中使用的一种临时措施。

集群里的从节点用于复制主节点，并在主节点下线时，代替主节点继续处理命令请求。

集群中的节点通过发送和接收信息来进行通信，常见的消息包括MEET、PING、PONG、PUBLISH和FAIL五种。